<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Newton AI - LAN Edition</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script src="https://unpkg.com/mathlive"></script>



    <style>

        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }

        .chat-container { height: calc(100vh - 180px); overflow-y: auto; }

        .message { max-width: 80%; margin: 10px 0; padding: 12px; border-radius: 12px; position: relative; }

        .user-msg { background-color: #3b82f6; color: white; margin-left: auto; border-bottom-right-radius: 2px; }

        .ai-msg { background-color: white; color: #1f2937; margin-right: auto; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }



        /* æ•°å­¦é”®ç›˜è¾“å…¥æ¡†æ ·å¼ */

        math-field {

            width: 100%;

            padding: 10px;

            background: white;

            border-radius: 8px;

            border: 1px solid #ddd;

            font-size: 1.2em;

        }

        /* éšè—è™šæ‹Ÿé”®ç›˜åˆ‡æ¢æŒ‰é’®ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ§åˆ¶ */

        math-field::part(virtual-keyboard-toggle) { display: none; }



        /* æ¸²æŸ“åçš„å…¬å¼æ ·å¼ */

        .katex { font-size: 1.1em; }

    </style>

</head>

<body class="flex flex-col h-screen max-w-4xl mx-auto p-4">



    <div class="text-center mb-4">

        <h1 class="text-2xl font-bold text-gray-800">ğŸ Sir Isaac Newton</h1>

        <p class="text-xs text-gray-500">MemOS Enhanced | LAN Access</p>

    </div>



    <div id="chat-box" class="chat-container flex flex-col p-2">

        <div class="ai-msg message">

            <p>å¾ä¹ƒè‰¾è¨å…‹Â·ç‰›é¡¿ã€‚æ±æœ‰ä½•æ•°å­¦å›°æƒ‘ï¼Ÿ</p>

        </div>

    </div>



    <div class="mt-auto bg-white p-4 rounded-xl shadow-lg">

        <math-field id="math-input" virtual-keyboard-mode="manual">

            \int_{0}^{\infty}

        </math-field>



        <div class="flex justify-between mt-2">

            <button onclick="toggleKeyboard()" class="text-blue-500 text-sm hover:underline">âŒ¨ï¸ åˆ‡æ¢é”®ç›˜</button>

            <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition">å‘é€ (Send)</button>

        </div>

    </div>



    <script>

        const mf = document.getElementById('math-input');

        const chatBox = document.getElementById('chat-box');



        // åˆ‡æ¢è™šæ‹Ÿæ•°å­¦é”®ç›˜æ˜¾ç¤º

        function toggleKeyboard() {

            if (mf.virtualKeyboardState === 'visible') {

                mf.virtualKeyboardState = 'hidden';

            } else {

                mf.virtualKeyboardState = 'visible';

            }

        }



        // å‘é€æ¶ˆæ¯æ ¸å¿ƒé€»è¾‘

        async function sendMessage() {

            // è·å– LaTeX å†…å®¹å¹¶è½¬ä¸ºæ–‡æœ¬

            const latex = mf.getValue();

            if (!latex) return;



            // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ (å°† LaTeX æ¸²æŸ“å‡ºæ¥)

            appendMessage(latex, 'user-msg');

            mf.setValue(''); // æ¸…ç©º



            // 2. åˆ›å»º AI æ¶ˆæ¯å ä½ç¬¦

            const aiMsgDiv = document.createElement('div');

            aiMsgDiv.className = 'message ai-msg prose';

            aiMsgDiv.innerHTML = '<span class="animate-pulse">Thinking...</span>';

            chatBox.appendChild(aiMsgDiv);

            scrollToBottom();



            try {

                // 3. è¯·æ±‚ Python åç«¯

                // æ³¨æ„ï¼šè¿™é‡Œç”¨ fetch æµå¼è¯»å–

                const response = await fetch('http://localhost:5000/chat', {

                    method: 'POST',

                    headers: { 'Content-Type': 'application/json' },

                    body: JSON.stringify({ message: latex, userId: 'SamSpend' })

                });



                const reader = response.body.getReader();

                const decoder = new TextDecoder();

                let aiText = '';



                aiMsgDiv.innerHTML = ''; // æ¸…ç©º Thinking



                while (true) {

                    const { done, value } = await reader.read();

                    if (done) break;



                    const chunk = decoder.decode(value);

                    aiText += chunk;



                    // å®æ—¶ Markdown + LaTeX æ¸²æŸ“

                    aiMsgDiv.innerHTML = marked.parse(aiText);

                    renderMathInElement(aiMsgDiv, {

                        delimiters: [

                            {left: '$$', right: '$$', display: true},

                            {left: '$', right: '$', display: false}

                        ]

                    });

                    scrollToBottom();

                }



            } catch (error) {

                aiMsgDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;

            }

        }



        function appendMessage(text, className) {

            const div = document.createElement('div');

            div.className = `message ${className}`;

            // å¦‚æœæ˜¯ç”¨æˆ·å‘é€çš„ï¼Œå°è¯•æ¸²æŸ“ LaTeX

            div.innerHTML = `$$ ${text} $$`;

            chatBox.appendChild(div);

            renderMathInElement(div, {

                delimiters: [{left: '$$', right: '$$', display: true}]

            });

            scrollToBottom();

        }



        function scrollToBottom() {

            chatBox.scrollTop = chatBox.scrollHeight;

        }



        // ç›‘å¬å›è½¦å‘é€

        mf.addEventListener('keydown', (ev) => {

            if (ev.key === 'Enter') sendMessage();

        });

    </script>

</body>

</html>